<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI - Admin</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="create_lesson_ai.html">‚ú® AI T·∫°o B√†i</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="users.html">Ng∆∞·ªùi D√πng</a></li>
                <li><a href="statistics.html">Th·ªëng K√™</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li> </ul>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 2rem;">Dashboard Qu·∫£n Tr·ªã</h1>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-label">T·ªïng Ng∆∞·ªùi D√πng</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCourses">-</div>
                <div class="stat-label">T·ªïng Kh√≥a H·ªçc</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalEnrollments">-</div>
                <div class="stat-label">T·ªïng ƒêƒÉng K√Ω</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completionRate">-</div>
                <div class="stat-label">T·ª∑ L·ªá Ho√†n Th√†nh</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Th·ªëng K√™ Chi Ti·∫øt</div>
            <div id="statisticsDetails">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load api.js -->
    <script src="../js/api.js"></script>
    <script>
        console.log('[ADMIN] Page loaded');
        console.log('[ADMIN] Checking authentication...');
        console.log('[ADMIN] Auth Token:', localStorage.getItem('auth_token') ? 'Present' : 'Missing');
        
        async function checkAdminAccess() {
            if (!isAuthenticated()) {
                console.log('[ADMIN] Not authenticated, redirecting to login');
                redirectTo('../index.html');
                return;
            }
            
            const user = await getCurrentUser();
            if (!user || user.role !== 'admin') {
                showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Ch·ªâ d√†nh cho Admin.', 'error');
                redirectTo('../index.html');
                return;
            }
        }
        
        // Check admin access first
        checkAdminAccess();
        
        async function loadStatistics() {
            try {
                console.log('[ADMIN] Loading statistics...');
                const stats = await adminAPI.getStatistics();
                console.log('[ADMIN] Statistics loaded:', stats);
                
                document.getElementById('totalUsers').textContent = stats.users.total;
                document.getElementById('totalCourses').textContent = stats.courses.total;
                document.getElementById('totalEnrollments').textContent = stats.enrollments;
                document.getElementById('completionRate').textContent = stats.completion.average_rate.toFixed(1) + '%';
                
                const details = document.getElementById('statisticsDetails');
                details.innerHTML = `
                    <h3>Ng∆∞·ªùi D√πng</h3>
                    <p><strong>T·ªïng:</strong> ${stats.users.total}</p>
                    <p><strong>ƒêang ho·∫°t ƒë·ªông:</strong> ${stats.users.active}</p>
                    
                    <h3 style="margin-top: 2rem;">Kh√≥a H·ªçc</h3>
                    <p><strong>T·ªïng:</strong> ${stats.courses.total}</p>
                    <p><strong>ƒêang ho·∫°t ƒë·ªông:</strong> ${stats.courses.active}</p>
                    
                    <h3 style="margin-top: 2rem;">T·ª∑ L·ªá Ho√†n Th√†nh</h3>
                    <p><strong>Trung b√¨nh:</strong> ${stats.completion.average_rate.toFixed(1)}%</p>
                `;
            } catch (error) {
                console.error('[ADMIN] Error loading statistics:', error);
                document.getElementById('statisticsDetails').innerHTML = `
                    <div style="color: red; padding: 20px;">
                        <p>‚ùå L·ªói t·∫£i th·ªëng k√™:</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        loadStatistics();
    </script>
</body>
</html>

