<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Kh√≥a H·ªçc - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Configure marked.js for Vietnamese text
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
    </script>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI - Admin</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="users.html">Ng∆∞·ªùi D√πng</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="statistics.html">Th·ªëng K√™</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; gap:12px;">
            <div style="flex:1; display:flex; gap:12px; align-items:center;">
                <h1 style="margin:0;">Qu·∫£n L√Ω Kh√≥a H·ªçc</h1>
                <input id="courseSearch" class="form-control" placeholder="T√¨m ki·∫øm kh√≥a h·ªçc..." style="max-width:320px;">
            </div>
            <button class="btn btn-primary" onclick="showCreateModal()">Th√™m Kh√≥a H·ªçc</button>
        </div>
        
        <div class="grid" id="coursesGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="courseModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="card-header" id="modalTitle">Th√™m Kh√≥a H·ªçc</div>
            <form id="courseForm">
                <div class="form-group">
                    <label for="course_name">T√™n Kh√≥a H·ªçc</label>
                    <input type="text" id="course_name" required>
                </div>
                <div class="form-group">
                    <label for="description">M√¥ T·∫£</label>
                    <textarea id="description" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="thumbnail_url">URL ·∫¢nh B√¨a</label>
                    <input type="url" id="thumbnail_url">
                </div>
                <hr>
                <div class="form-group">
                    <label>Danh s√°ch B√†i Gi·∫£ng</label>
                    <div id="lessonsList" style="max-height: 240px; overflow-y: auto; border: 1px solid #eee; padding: 8px; border-radius: 6px; background: #fafafa;">
                        <p class="muted">Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.</p>
                    </div>
                </div>
                <hr>
                <div class="form-group">
                    <label>Danh s√°ch h·ªçc vi√™n ƒë√£ ghi danh</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input id="enrollUserInput" class="form-control" placeholder="User ID ho·∫∑c Email ƒë·ªÉ ghi danh">
                        <button class="btn btn-primary" onclick="enrollUserAction()">Ghi danh</button>
                    </div>
                    <div id="enrollmentsList" style="max-height:160px; overflow-y:auto; border:1px solid #eee; padding:8px; border-radius:6px; background:#fff;">
                        <p class="muted">Ch∆∞a c√≥ h·ªçc vi√™n n√†o.</p>
                    </div>
                </div>
                <div id="lessonPreview" style="display:none; margin-top:12px; border-top:1px solid #eee; padding-top:10px;">
                    <h4>Xem b√†i gi·∫£ng</h4>
                    <div id="lessonPreviewTitle" style="font-weight:700"></div>
                    <div id="lessonPreviewContent" style="margin-top:8px; max-height:280px; overflow-y:auto; background:#fff; padding:8px; border-radius:6px; border:1px solid #eee; font-family: 'Segoe UI', Tahoma, 'Microsoft Sans Serif', Arial, sans-serif; line-height: 1.6;"></div>
                </div>

                <div id="lessonEditForm" style="display:none; margin-top:12px; border-top:1px solid #eee; padding-top:10px;">
                    <h4>Ch·ªânh s·ª≠a b√†i gi·∫£ng</h4>
                    <div class="form-group">
                        <label>Ti√™u ƒë·ªÅ</label>
                        <input type="text" id="editLessonTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi l∆∞·ª£ng (ph√∫t)</label>
                        <input type="number" id="editLessonDuration" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Video URL (YouTube ho·∫∑c MP4)</label>
                        <input type="url" id="editLessonVideo" class="form-control" placeholder="https://www.youtube.com/watch?v=... ho·∫∑c link mp4">
                    </div>
                    <div class="form-group">
                        <label>N·ªôi dung (Markdown)</label>
                        <textarea id="editLessonContent" rows="8" class="form-control"></textarea>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-primary" onclick="saveEditedLesson()">L∆∞u b√†i</button>
                        <button class="btn btn-secondary" onclick="cancelEditLesson()">H·ªßy</button>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">L∆∞u</button>
                    <button type="button" class="btn btn-secondary" onclick="hideModal()">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let editingCourseId = null;
        
        if (!isAuthenticated()) {
            redirectTo('../index.html');
        }
        
        // N·∫øu URL c√≥ query param id, l∆∞u l·∫°i ƒë·ªÉ m·ªü modal khi load xong
        const openCourseIdFromQuery = new URLSearchParams(window.location.search).get('id');

        async function loadCourses() {
            try {
                const courses = await coursesAPI.getAll(false);
                renderCourses(courses);

                // N·∫øu c√≥ id trong query string, m·ªü modal ch·ªânh s·ª≠a kh√≥a h·ªçc ƒë√≥
                if (openCourseIdFromQuery) {
                    const id = parseInt(openCourseIdFromQuery);
                    if (!isNaN(id)) {
                        // T√¨m trang ƒë√£ render xong, sau ƒë√≥ g·ªçi editCourse
                        // Small delay to ensure buttons/rendering completed
                        setTimeout(() => editCourse(id), 100);
                    }
                }
            } catch (error) {
                showAlert('L·ªói t·∫£i kh√≥a h·ªçc: ' + error.message, 'error');
            }
        }
        
        function renderCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            
            const filter = document.getElementById('courseSearch') ? document.getElementById('courseSearch').value.toLowerCase() : '';
            const filtered = courses.filter(c => !filter || (c.course_name && c.course_name.toLowerCase().includes(filter)));

            if (filtered.length === 0) {
                grid.innerHTML = '<p>Ch∆∞a c√≥ kh√≥a h·ªçc n√†o.</p>';
                return;
            }
            
            grid.innerHTML = filtered.map(course => `
                <div class="course-card">
                    ${course.thumbnail_url ? `<img src="${course.thumbnail_url}" alt="${course.course_name}">` : ''}
                    <div class="course-card-body">
                        <h3>${course.course_name}</h3>
                        <p>${course.description ? (course.description.substring(0, 100) + '...') : ''}</p>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary" onclick="editCourse(${course.course_id})">S·ª≠a</button>
                            <button class="btn btn-danger" onclick="deleteCourse(${course.course_id})">X√≥a</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function showCreateModal() {
        editingCourseId = null;
        document.getElementById('modalTitle').textContent = 'Th√™m Kh√≥a H·ªçc';
        document.getElementById('courseForm').reset();
        document.getElementById('courseModal').style.display = 'flex'; 
    }

    function hideModal() {
        document.getElementById('courseModal').style.display = 'none'; 
    }
        
        async function editCourse(courseId) {
            try {
                const course = await coursesAPI.getById(courseId);
                editingCourseId = courseId;
                document.getElementById('modalTitle').textContent = 'S·ª≠a Kh√≥a H·ªçc';
                document.getElementById('course_name').value = course.course_name;
                document.getElementById('description').value = course.description || '';
                document.getElementById('thumbnail_url').value = course.thumbnail_url || '';
                document.getElementById('courseModal').style.display = 'flex';

                // Load lessons for this course and render inside modal
                try {
                    const lessons = await apiRequest(`/admin/courses/${courseId}/lessons`);
                    const list = document.getElementById('lessonsList');
                    if (!lessons || lessons.length === 0) {
                        list.innerHTML = '<p class="muted">Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.</p>';
                    } else {
                        list.innerHTML = lessons.map(ls => `
                            <div id="lesson-item-${ls.lesson_id}" data-lesson-id="${ls.lesson_id}" style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                <div style="flex:1;">
                                    <strong>${ls.lesson_title}</strong>
                                    <div class="muted" style="font-size:12px">Th·ªùi l∆∞·ª£ng: ${ls.duration_minutes || '-'} ph√∫t</div>
                                </div>
                                <div style="display:flex; gap:8px; margin-left:12px;">
                                    <button class="btn btn-sm btn-outline" onclick="previewLesson(${ls.lesson_id})">Chi ti·∫øt</button>
                                    <button class="btn btn-sm btn-primary" onclick="openEditLesson(${ls.lesson_id})">S·ª≠a</button>
                                    <a class="btn btn-sm btn-success" href="../student/lesson.html?id=${ls.lesson_id}" target="_blank">M·ªü trang</a>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteLesson(${ls.lesson_id})">X√≥a</button>
                                </div>
                            </div>
                        `).join('');

                        // N·∫øu c√≥ lesson id m·ªõi mu·ªën highlight
                        const newLessonId = new URLSearchParams(window.location.search).get('new_lesson_id');
                        if (newLessonId) {
                            const el = document.getElementById(`lesson-item-${newLessonId}`);
                            if (el) {
                                el.style.background = '#fff8cc';
                                el.style.transition = 'background 0.6s ease';
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                // remove highlight after a while
                                setTimeout(() => el.style.background = '', 4000);
                            }
                        }
                    }
                } catch (err) {
                    document.getElementById('lessonsList').innerHTML = '<p class="muted">L·ªói t·∫£i b√†i gi·∫£ng.</p>';
                    console.error('L·ªói t·∫£i b√†i gi·∫£ng:', err);
                }
                    // Load enrollments
                    try {
                        const enrolls = await apiRequest(`/admin/courses/${courseId}/enrollments`);
                        const el = document.getElementById('enrollmentsList');
                        if (!enrolls || enrolls.length === 0) {
                            el.innerHTML = '<p class="muted">Ch∆∞a c√≥ h·ªçc vi√™n n√†o.</p>';
                        } else {
                            el.innerHTML = enrolls.map(en => `
                                <div style="display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #eee;">
                                    <div>
                                        <strong>ID: ${en.user_id}</strong>
                                        <div class="muted" style="font-size:12px">Progress: ${en.progress_percentage || 0}%</div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-danger" onclick="unenrollUserAction(${en.user_id})">G·ª°</button>
                                    </div>
                                </div>
                            `).join('');
                        }
                    } catch (err) {
                        document.getElementById('enrollmentsList').innerHTML = '<p class="muted">L·ªói t·∫£i danh s√°ch h·ªçc vi√™n.</p>';
                    }
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }
        
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseData = {
                course_name: document.getElementById('course_name').value,
                description: document.getElementById('description').value,
                thumbnail_url: document.getElementById('thumbnail_url').value
            };
            
            try {
                if (editingCourseId) {
                    await adminAPI.updateCourse(editingCourseId, courseData);
                    showAlert('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                } else {
                    await adminAPI.createCourse(courseData);
                    showAlert('T·∫°o kh√≥a h·ªçc th√†nh c√¥ng!', 'success');
                }
                hideModal();
                loadCourses();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        });
        
        async function deleteCourse(courseId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a kh√≥a h·ªçc n√†y?')) return;
            
            try {
                await adminAPI.deleteCourse(courseId);
                showAlert('ƒê√£ x√≥a kh√≥a h·ªçc', 'success');
                loadCourses();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function confirmDeleteLesson(lessonId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i gi·∫£ng n√†y?')) return;
            try {
                await adminAPI.deleteLesson(lessonId);
                showAlert('ƒê√£ x√≥a b√†i gi·∫£ng', 'success');
                // reload lessons for current course
                if (editingCourseId) {
                    const lessons = await apiRequest(`/admin/courses/${editingCourseId}/lessons`);
                    const list = document.getElementById('lessonsList');
                    if (!lessons || lessons.length === 0) {
                        list.innerHTML = '<p class="muted">Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.</p>';
                    } else {
                        list.innerHTML = lessons.map(ls => `
                            <div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                <div style="flex:1;">
                                    <strong>${ls.lesson_title}</strong>
                                    <div class="muted" style="font-size:12px">Th·ªùi l∆∞·ª£ng: ${ls.duration_minutes || '-'} ph√∫t</div>
                                </div>
                                <div style="display:flex; gap:8px; margin-left:12px;">
                                    <a class="btn btn-sm btn-primary" href="../student/lesson.html?id=${ls.lesson_id}" target="_blank">Xem</a>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteLesson(${ls.lesson_id})">X√≥a</button>
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                showAlert('L·ªói x√≥a b√†i gi·∫£ng: ' + error.message, 'error');
            }
        }

        async function enrollUserAction() {
            const input = document.getElementById('enrollUserInput').value.trim();
            if (!input) return showAlert('Nh·∫≠p user id ho·∫∑c email ƒë·ªÉ ghi danh', 'error');
            // try to interpret as id first
            let userId = parseInt(input);
            try {
                if (isNaN(userId)) {
                    // resolve by email via admin users list
                    const users = await adminAPI.getUsers();
                    const found = users.find(u => u.email === input || u.username === input);
                    if (!found) return showAlert('Kh√¥ng t√¨m th·∫•y user v·ªõi email/username n√†y', 'error');
                    userId = found.user_id;
                }
                await apiRequest(`/admin/courses/${editingCourseId}/enroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                showAlert('Ghi danh th√†nh c√¥ng', 'success');
                // reload enrollments
                const enrolls = await apiRequest(`/admin/courses/${editingCourseId}/enrollments`);
                const el = document.getElementById('enrollmentsList');
                if (!enrolls || enrolls.length === 0) el.innerHTML = '<p class="muted">Ch∆∞a c√≥ h·ªçc vi√™n n√†o.</p>';
                else el.innerHTML = enrolls.map(en => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #eee;">
                        <div>
                            <strong>ID: ${en.user_id}</strong>
                            <div class="muted" style="font-size:12px">Progress: ${en.progress_percentage || 0}%</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="unenrollUserAction(${en.user_id})">G·ª°</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                showAlert('L·ªói ghi danh: ' + err.message, 'error');
            }
        }

        async function unenrollUserAction(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën g·ª° h·ªçc vi√™n n√†y kh·ªèi kh√≥a?')) return;
            try {
                await apiRequest(`/admin/courses/${editingCourseId}/unenroll`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                showAlert('ƒê√£ g·ª° h·ªçc vi√™n', 'success');
                // refresh enrollments
                const enrolls = await apiRequest(`/admin/courses/${editingCourseId}/enrollments`);
                const el = document.getElementById('enrollmentsList');
                if (!enrolls || enrolls.length === 0) el.innerHTML = '<p class="muted">Ch∆∞a c√≥ h·ªçc vi√™n n√†o.</p>';
                else el.innerHTML = enrolls.map(en => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #eee;">
                        <div>
                            <strong>ID: ${en.user_id}</strong>
                            <div class="muted" style="font-size:12px">Progress: ${en.progress_percentage || 0}%</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="unenrollUserAction(${en.user_id})">G·ª°</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                showAlert('L·ªói: ' + err.message, 'error');
            }
        }

        async function previewLesson(lessonId) {
            try {
                const lesson = await lessonsAPI.getById(lessonId);
                document.getElementById('lessonPreviewTitle').textContent = lesson.lesson_title;
                // Render video if present (YouTube embed or video tag)
                let contentHtml = '';
                if (lesson.video_url) {
                    const vid = lesson.video_url;
                    const ytMatch = vid.match(/(?:v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/);
                    if (ytMatch) {
                        const vidId = ytMatch[1];
                        contentHtml += `<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:6px;margin-bottom:12px;"><iframe src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;"></iframe></div>`;
                    } else {
                        contentHtml += `<div style="margin:12px 0;"><video controls style="width:100%;border-radius:6px;"><source src="${vid}"></video></div>`;
                    }
                }
                contentHtml += marked.parse(lesson.lesson_content || '');
                document.getElementById('lessonPreviewContent').innerHTML = contentHtml;
                document.getElementById('lessonPreview').style.display = 'block';
                // hide edit form if open
                document.getElementById('lessonEditForm').style.display = 'none';
            } catch (err) {
                showAlert('L·ªói t·∫£i n·ªôi dung b√†i gi·∫£ng: ' + err.message, 'error');
            }
        }

        let editingLessonId = null;
        async function openEditLesson(lessonId) {
            try {
                const lesson = await lessonsAPI.getById(lessonId);
                editingLessonId = lessonId;
                document.getElementById('editLessonTitle').value = lesson.lesson_title || '';
                document.getElementById('editLessonDuration').value = lesson.duration_minutes || '';
                document.getElementById('editLessonVideo').value = lesson.video_url || '';
                document.getElementById('editLessonContent').value = lesson.lesson_content || '';
                document.getElementById('lessonEditForm').style.display = 'block';
                document.getElementById('lessonPreview').style.display = 'none';
            } catch (err) {
                showAlert('L·ªói t·∫£i b√†i gi·∫£ng ƒë·ªÉ s·ª≠a: ' + err.message, 'error');
            }
        }

        function cancelEditLesson() {
            editingLessonId = null;
            document.getElementById('lessonEditForm').style.display = 'none';
        }

        async function saveEditedLesson() {
            if (!editingLessonId) return showAlert('Kh√¥ng c√≥ b√†i gi·∫£ng ƒëang s·ª≠a', 'error');
            const data = {
                lesson_title: document.getElementById('editLessonTitle').value,
                lesson_content: document.getElementById('editLessonContent').value,
                duration_minutes: parseInt(document.getElementById('editLessonDuration').value) || null,
                video_url: (document.getElementById('editLessonVideo').value || null)
            };
            try {
                await adminAPI.updateLesson(editingLessonId, data);
                showAlert('C·∫≠p nh·∫≠t b√†i gi·∫£ng th√†nh c√¥ng', 'success');
                // refresh lessons list
                const lessons = await apiRequest(`/admin/courses/${editingCourseId}/lessons`);
                const list = document.getElementById('lessonsList');
                if (!lessons || lessons.length === 0) {
                    list.innerHTML = '<p class="muted">Ch∆∞a c√≥ b√†i gi·∫£ng n√†o.</p>';
                } else {
                    list.innerHTML = lessons.map(ls => `
                        <div id="lesson-item-${ls.lesson_id}" data-lesson-id="${ls.lesson_id}" style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <strong>${ls.lesson_title}</strong>
                                <div class="muted" style="font-size:12px">Th·ªùi l∆∞·ª£ng: ${ls.duration_minutes || '-'} ph√∫t</div>
                            </div>
                            <div style="display:flex; gap:8px; margin-left:12px;">
                                <button class="btn btn-sm btn-outline" onclick="previewLesson(${ls.lesson_id})">Chi ti·∫øt</button>
                                <button class="btn btn-sm btn-primary" onclick="openEditLesson(${ls.lesson_id})">S·ª≠a</button>
                                <a class="btn btn-sm btn-success" href="../student/lesson.html?id=${ls.lesson_id}" target="_blank">M·ªü trang</a>
                                <button class="btn btn-sm btn-danger" onclick="confirmDeleteLesson(${ls.lesson_id})">X√≥a</button>
                            </div>
                        </div>
                    `).join('');
                }
                cancelEditLesson();
            } catch (err) {
                showAlert('L·ªói l∆∞u b√†i gi·∫£ng: ' + err.message, 'error');
            }
        }
        
        // attach search handler
        const courseSearchInput = document.getElementById('courseSearch');
        if (courseSearchInput) courseSearchInput.addEventListener('input', () => loadCourses());

        loadCourses();
    </script>
</body>
</html>

