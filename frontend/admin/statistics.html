<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th·ªëng K√™ Chi Ti·∫øt - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI - Admin</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="users.html">Ng∆∞·ªùi D√πng</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="statistics.html" class="active">Th·ªëng K√™</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 2rem;">B√°o C√°o Th·ªëng K√™ Chi Ti·∫øt</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="statUsers">-</div>
                <div class="stat-label">Ng∆∞·ªùi D√πng</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCourses">-</div>
                <div class="stat-label">Kh√≥a H·ªçc</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statEnrollments">-</div>
                <div class="stat-label">L∆∞·ª£t ƒêƒÉng K√Ω</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCompletion">-</div>
                <div class="stat-label">T·ª∑ L·ªá Ho√†n Th√†nh</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>Ph√¢n B·ªë Ng∆∞·ªùi D√πng</h3>
                <canvas id="userChart"></canvas>
            </div>
            
            <div class="chart-container">
                <h3>T√¨nh Tr·∫°ng H·ªçc T·∫≠p</h3>
                <canvas id="progressChart"></canvas>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        async function checkAdminAccess() {
            if (!isAuthenticated()) {
                redirectTo('../index.html');
                return;
            }
            
            const user = await getCurrentUser();
            if (!user || user.role !== 'admin') {
                showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Ch·ªâ d√†nh cho Admin.', 'error');
                redirectTo('../index.html');
                return;
            }
        }
        
        // Check admin access first
        checkAdminAccess();

        async function initStatistics() {
            try {
                const stats = await adminAPI.getStatistics();
                console.log('Stats loaded:', stats);

                // 1. C·∫≠p nh·∫≠t s·ªë li·ªáu t·ªïng quan
                document.getElementById('statUsers').textContent = stats.users.total;
                document.getElementById('statCourses').textContent = stats.courses.total;
                document.getElementById('statEnrollments').textContent = stats.enrollments;
                document.getElementById('statCompletion').textContent = stats.completion.average_rate.toFixed(1) + '%';

                // 2. V·∫Ω bi·ªÉu ƒë·ªì Ng∆∞·ªùi d√πng (Active vs Inactive)
                const userCtx = document.getElementById('userChart').getContext('2d');
                new Chart(userCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['ƒêang ho·∫°t ƒë·ªông', 'Kh√¥ng ho·∫°t ƒë·ªông'],
                        datasets: [{
                            data: [stats.users.active, stats.users.total - stats.users.active],
                            backgroundColor: ['#28a745', '#dc3545']
                        }]
                    },
                    options: { responsive: true }
                });

                // 3. V·∫Ω bi·ªÉu ƒë·ªì Ti·∫øn ƒë·ªô (Ho√†n th√†nh vs ƒêang h·ªçc vs Ch∆∞a h·ªçc)
                const progressCtx = document.getElementById('progressChart').getContext('2d');
                const details = stats.completion.details || { completed: 0, in_progress: 0, not_started: 0 };
                
                new Chart(progressCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Ho√†n th√†nh', 'ƒêang h·ªçc', 'Ch∆∞a b·∫Øt ƒë·∫ßu'],
                        datasets: [{
                            label: 'S·ªë l∆∞·ª£ng h·ªçc vi√™n',
                            data: [details.completed, details.in_progress, details.not_started],
                            backgroundColor: ['#28a745', '#ffc107', '#6c757d']
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });

            } catch (error) {
                console.error('L·ªói t·∫£i th·ªëng k√™:', error);
                showAlert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™: ' + error.message, 'error');
            }
        }

        // Ch·∫°y khi trang t·∫£i xong
        document.addEventListener('DOMContentLoaded', initStatistics);
    </script>
</body>
</html>