<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Ng∆∞·ªùi D√πng - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI - Admin</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="users.html">Ng∆∞·ªùi D√πng</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="statistics.html">Th·ªëng K√™</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:1rem;">
            <h1 style="margin:0;">Qu·∫£n L√Ω Ng∆∞·ªùi D√πng</h1>
            <input id="userSearch" class="form-control" placeholder="T√¨m theo t√™n/email/username" style="max-width:360px;">
        </div>
        
        <div class="card">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                        <th>H·ªç T√™n</th>
                        <th>Email</th>
                        <th>Vai Tr√≤</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <tr>
                        <td colspan="7" style="text-align: center;">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng</h3>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <label>Vai tr√≤
                    <select id="editUserRole" class="form-control">
                        <option value="student">Student</option>
                        <option value="instructor">Instructor</option>
                        <option value="admin">Admin</option>
                    </select>
                </label>

                <label style="display:flex;align-items:center;gap:8px;">Active
                    <input type="checkbox" id="editUserActive">
                </label>

                <label>New Password
                    <input id="editUserPassword" class="form-control" placeholder="Leave blank to keep current">
                </label>

                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px;">
                    <button class="btn" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveEditUser()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center}
        .modal-content{background:#fff;padding:20px;border-radius:6px;min-width:320px;max-width:480px}
    </style>

    <script src="../js/api.js"></script>
    <script>
        if (!isAuthenticated()) {
            redirectTo('../index.html');
        }
        // search box handler
        function setupUserSearch() {
            const input = document.getElementById('userSearch');
            if (input) input.addEventListener('input', () => loadUsers());
        }
        
        async function loadUsers() {
            try {
                const users = await adminAPI.getUsers();
                renderUsers(users);
            } catch (error) {
                showAlert('L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng: ' + error.message, 'error');
            }
        }
        
        function renderUsers(users) {
            const tbody = document.getElementById('usersTable');
            const search = document.getElementById('userSearch') ? document.getElementById('userSearch').value.toLowerCase() : '';
            const filtered = users.filter(u => !search || (u.full_name && u.full_name.toLowerCase().includes(search)) || (u.email && u.email.toLowerCase().includes(search)) || (u.username && u.username.toLowerCase().includes(search)));
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o.</td></tr>';
                return;
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Kh√¥ng c√≥ ng∆∞·ªùi d√πng ph√π h·ª£p.</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(user => `
                <tr>
                    <td>${user.user_id}</td>
                    <td>${user.username}</td>
                    <td>${user.full_name}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td>${user.is_active ? '<span style="color: var(--success-color);">Ho·∫°t ƒë·ªông</span>' : '<span style="color: var(--danger-color);">Kh√≥a</span>'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="openEditUser(${user.user_id})">Edit</button>
                        ${user.is_active ? `
                            <button class="btn btn-warning" onclick="deactivateUser(${user.user_id})">Kh√≥a</button>
                        ` : `
                            <button class="btn btn-success" onclick="activateUser(${user.user_id})">K√≠ch Ho·∫°t</button>
                        `}
                        <button class="btn btn-danger" onclick="deleteUser(${user.user_id})">X√≥a</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function deactivateUser(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh√≥a ng∆∞·ªùi d√πng n√†y?')) return;
            
            try {
                await adminAPI.deactivateUser(userId);
                showAlert('ƒê√£ kh√≥a ng∆∞·ªùi d√πng', 'success');
                loadUsers();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }
        
        async function activateUser(userId) {
            try {
                await adminAPI.activateUser(userId);
                showAlert('ƒê√£ k√≠ch ho·∫°t ng∆∞·ªùi d√πng', 'success');
                loadUsers();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }
        
        async function deleteUser(userId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) return;
            
            try {
                await adminAPI.deleteUser(userId);
                showAlert('ƒê√£ x√≥a ng∆∞·ªùi d√πng', 'success');
                loadUsers();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }
        
        setupUserSearch();
        loadUsers();
        
        // ----- Edit user modal logic -----
        function closeEditModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function openEditUser(userId) {
            try {
                const users = await adminAPI.getUsers();
                const user = users.find(u => u.user_id === userId);
                if (!user) {
                    showAlert('Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng', 'error');
                    return;
                }

                document.getElementById('editUserRole').value = user.role || 'student';
                document.getElementById('editUserActive').checked = !!user.is_active;
                document.getElementById('editUserPassword').value = '';
                // store editing id on modal element
                document.getElementById('editUserModal').dataset.editUserId = String(userId);
                document.getElementById('editUserModal').style.display = 'flex';
            } catch (error) {
                showAlert('L·ªói m·ªü modal ch·ªânh s·ª≠a: ' + error.message, 'error');
            }
        }

        async function saveEditUser() {
            const modal = document.getElementById('editUserModal');
            const userId = parseInt(modal.dataset.editUserId || '0', 10);
            if (!userId) return showAlert('Invalid user id', 'error');

            const role = document.getElementById('editUserRole').value;
            const is_active = document.getElementById('editUserActive').checked;
            const password = document.getElementById('editUserPassword').value;

            const payload = { role, is_active };
            if (password && password.trim().length > 0) payload.password = password.trim();

            try {
                await adminAPI.updateUser(userId, payload);
                showAlert('ƒê√£ c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng', 'success');
                closeEditModal();
                loadUsers();
            } catch (error) {
                showAlert('L·ªói l∆∞u thay ƒë·ªïi: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

