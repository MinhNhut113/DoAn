<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI T·∫°o B√†i Gi·∫£ng - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // Configure marked.js for Vietnamese text
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false
        });
    </script>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì Admin - AI Studio</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 1.5rem;">AI T·∫°o N·ªôi Dung B√†i Gi·∫£ng</h1>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
                <div class="card-header">Nh·∫≠p Y√™u C·∫ßu</div>
                <div class="form-group">
                    <label>Ch·ªß ƒë·ªÅ b√†i h·ªçc</label>
                    <input type="text" id="topicInput" class="form-control" placeholder="V√≠ d·ª•: Gi·ªõi thi·ªáu v·ªÅ Python, SQL c∆° b·∫£n...">
                </div>
                <div class="form-group">
                    <label>Tr√¨nh ƒë·ªô</label>
                    <select id="levelInput" class="form-control">
                        <option value="beginner">C∆° b·∫£n (Ng∆∞·ªùi m·ªõi b·∫Øt ƒë·∫ßu)</option>
                        <option value="intermediate">Trung b√¨nh</option>
                        <option value="advanced">N√¢ng cao</option>
                    </select>
                </div>
                <button onclick="generateLesson()" class="btn btn-primary" id="btnGenerate" style="width: 100%; margin-top: 10px;">
                    ü§ñ B·∫Øt ƒë·∫ßu t·∫°o (AI)
                </button>
            </div>

            <div class="card">
                <div class="card-header">K·∫øt Qu·∫£ AI</div>
                <div id="loadingArea" style="display: none; text-align: center; padding: 20px;">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">AI ƒëang so·∫°n b√†i, vui l√≤ng ch·ªù kho·∫£ng 30s...</p>
                </div>
                
                <div id="resultArea" style="display: none;">
                    <div class="form-group">
                        <label>Ch·ªçn Kh√≥a H·ªçc:</label>
                        <select id="courseSelect" class="form-control">
                            <option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ti√™u ƒë·ªÅ:</label>
                        <input type="text" id="resultTitle" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>T√≥m t·∫Øt:</label>
                        <textarea id="resultSummary" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>N·ªôi dung chi ti·∫øt (Markdown):</label>
                        <textarea id="resultContent" class="form-control" rows="10"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Xem tr∆∞·ªõc:</label>
                        <div id="previewContent" style="border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f9f9f9; max-height: 300px; overflow-y: auto; font-family: 'Segoe UI', Tahoma, 'Microsoft Sans Serif', Arial, sans-serif; line-height: 1.6;"></div>
                    </div>
                    <button onclick="saveLesson()" class="btn btn-success" style="width: 100%;">üíæ L∆∞u b√†i h·ªçc n√†y</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        async function checkAdminAccess() {
            if (!isAuthenticated()) {
                redirectTo('../index.html');
                return;
            }
            
            const user = await getCurrentUser();
            if (!user || user.role !== 'admin') {
                showAlert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Ch·ªâ d√†nh cho Admin.', 'error');
                redirectTo('../index.html');
                return;
            }
        }
        
        // Check admin access first
        checkAdminAccess();

        let allCourses = [];

        // Load danh s√°ch kh√≥a h·ªçc khi trang load
        async function loadCourses() {
            try {
                const courses = await coursesAPI.getAll();
                allCourses = courses;
                const select = document.getElementById('courseSelect');
                select.innerHTML = '<option value="">-- Ch·ªçn kh√≥a h·ªçc --</option>';
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.course_id;
                    option.textContent = course.course_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói t·∫£i kh√≥a h·ªçc:', error);
                showAlert('L·ªói t·∫£i danh s√°ch kh√≥a h·ªçc', 'error');
            }
        }

        async function generateLesson() {
            const topic = document.getElementById('topicInput').value;
            const level = document.getElementById('levelInput').value;

            if (!topic) {
                showAlert('Vui l√≤ng nh·∫≠p ch·ªß ƒë·ªÅ!', 'error');
                return;
            }

            // Hi·ªáu ·ª©ng Loading
            document.getElementById('btnGenerate').disabled = true;
            document.getElementById('loadingArea').style.display = 'block';
            document.getElementById('resultArea').style.display = 'none';

            try {
                // G·ªçi API AI
                const data = await aiAPI.generateLesson(topic, level);
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                document.getElementById('resultTitle').value = data.title;
                document.getElementById('resultSummary').value = data.summary;
                document.getElementById('resultContent').value = data.content;
                
                // Render Markdown ra HTML ƒë·ªÉ xem tr∆∞·ªõc
                document.getElementById('previewContent').innerHTML = marked.parse(data.content);
                
                document.getElementById('resultArea').style.display = 'block';
                showAlert('ƒê√£ t·∫°o b√†i gi·∫£ng th√†nh c√¥ng!', 'success');

            } catch (error) {
                console.error(error);
                showAlert('L·ªói AI: ' + error.message, 'error');
            } finally {
                document.getElementById('btnGenerate').disabled = false;
                document.getElementById('loadingArea').style.display = 'none';
            }
        }

        async function saveLesson() {
            const courseId = document.getElementById('courseSelect').value;
            const title = document.getElementById('resultTitle').value;
            const content = document.getElementById('resultContent').value;
            const summary = document.getElementById('resultSummary').value;

            if (!courseId) {
                showAlert('Vui l√≤ng ch·ªçn kh√≥a h·ªçc!', 'error');
                return;
            }

            if (!title || !content) {
                showAlert('Ti√™u ƒë·ªÅ v√† n·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!', 'error');
                return;
            }

            try {
                const lessonData = {
                    course_id: parseInt(courseId),
                    lesson_title: title,
                    lesson_content: content,
                    lesson_order: 999, // Th·ª© t·ª± t·∫°m th·ªùi (admin c√≥ th·ªÉ s·ª≠a sau)
                    duration_minutes: 15
                };

                const response = await adminAPI.createLesson(lessonData);
                showAlert('‚úÖ B√†i gi·∫£ng ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!', 'success');

                // L·∫•y lesson_id tr·∫£ v·ªÅ t·ª´ backend v√† chuy·ªÉn t·ªõi courses.html
                const newLessonId = response && response.lesson && response.lesson.lesson_id ? response.lesson.lesson_id : null;
                const qs = new URLSearchParams();
                qs.set('id', courseId);
                if (newLessonId) qs.set('new_lesson_id', newLessonId);
                window.location.href = `courses.html?${qs.toString()}`;

            } catch (error) {
                console.error('L·ªói l∆∞u b√†i gi·∫£ng:', error);
                showAlert('L·ªói l∆∞u b√†i gi·∫£ng: ' + error.message, 'error');
            }
        }

        // Load kh√≥a h·ªçc khi trang load xong
        window.addEventListener('load', loadCourses);
    </script>
</body>
</html>