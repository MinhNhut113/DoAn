<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sinh Vi√™n</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li style="position:relative;" id="notifNavItem">
                    <a href="#" onclick="openNotifications()">üîî <span id="notifBadge" style="background:#dc2626;color:white;padding:2px 6px;border-radius:12px;font-size:12px;display:none;margin-left:6px;">0</span></a>
                </li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="progress.html">Ti·∫øn ƒê·ªô</a></li>
                <li><a href="profile.html">H·ªì S∆°</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:white; max-width:640px; width:92%; max-height:80vh; overflow:auto; border-radius:8px; padding:16px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Th√¥ng b√°o c·ªßa b·∫°n</h3>
                <button class="btn" onclick="closeNotifications()">ƒê√≥ng</button>
            </div>
            <div id="notificationsList" style="margin-top:12px;"></div>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 2rem;">Dashboard</h1>
        
        <!-- Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalCourses">-</div>
                <div class="stat-label">Kh√≥a H·ªçc</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedLessons">-</div>
                <div class="stat-label">B√†i H·ªçc Ho√†n Th√†nh</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">-</div>
                <div class="stat-label">ƒêi·ªÉm Trung B√¨nh</div>
            </div>
        </div>
        
        <!-- Learning Goal Card -->
        <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>üéØ M·ª•c Ti√™u C·ªßa T√¥i</span>
                <button id="editGoalBtn" class="btn btn-sm" onclick="toggleEditGoal()" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è S·ª≠a</button>
            </div>
            <div id="goalDisplay" style="padding: 16px; min-height: 80px;">
                <p id="goalText" style="font-size: 16px; line-height: 1.6; margin: 0; color: #444;"></p>
            </div>
            <div id="goalEditForm" style="display: none; padding: 16px; border-top: 1px solid #e5e7eb;">
                <textarea id="goalInput" placeholder="Nh·∫≠p m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa b·∫°n..." style="width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; margin-bottom: 8px; resize: none;"></textarea>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" onclick="saveGoal()" style="flex: 1;">L∆∞u</button>
                    <button class="btn" onclick="toggleEditGoal()" style="flex: 1;">H·ªßy</button>
                </div>
            </div>
        </div>
        
        <!-- AI Recommendations -->
        <div class="card">
            <div class="card-header">üéØ G·ª£i √ù t·ª´ AI</div>
            <div id="recommendations">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i g·ª£i √Ω...</p>
                </div>
            </div>
        </div>
        
        <!-- Recent Courses -->
        <div class="card">
            <div class="card-header">Kh√≥a H·ªçc C·ªßa T√¥i</div>
            <div class="grid" id="coursesGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Recent Quiz Results -->
        <div class="card">
            <div class="card-header">K·∫øt Qu·∫£ Ki·ªÉm Tra G·∫ßn ƒê√¢y</div>
            <div id="recentQuizzes">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Floating Button & Modal -->
    <div id="chatbotContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
        <div id="chatModal" style="display: none; width: 400px; height: 500px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-direction: column; overflow: hidden;">
            <div style="background: var(--primary-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold;">ü§ñ AI Chatbot</span>
                <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">‚úï</button>
            </div>
            <div id="chatMessages" style="flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px;"></div>
            <div style="padding: 15px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                <input type="text" id="chatInput" placeholder="ƒê·∫∑t c√¢u h·ªèi..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                <button onclick="sendChatMessage()" style="padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">G·ª≠i</button>
            </div>
        </div>
        <button id="chatToggle" onclick="toggleChat()" style="width: 60px; height: 60px; border-radius: 50%; background: var(--primary-color); color: white; border: none; cursor: pointer; font-size: 24px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-weight: bold;">üí¨</button>
    </div>

    <script src="../js/api.js"></script>
    <script>
        // Check authentication
        if (!isAuthenticated()) {
            redirectTo('../index.html');
        }
        
        async function loadDashboard() {
            try {
                // Load user profile to get learning goal
                const profile = await authAPI.getProfile();
                displayLearningGoal(profile.learning_goal);
                
                // Load dashboard data
                const dashboardData = await progressAPI.getDashboard();
                
                // Update stats
                document.getElementById('totalCourses').textContent = dashboardData.courses_progress.length;
                document.getElementById('completedLessons').textContent = dashboardData.total_lessons_completed;
                
                // Load courses
                const courses = await coursesAPI.getAll(true);
                renderCourses(courses.slice(0, 6));
                
                // Render recent quizzes
                renderRecentQuizzes(dashboardData.recent_quizzes);
                
                // Load AI recommendations
                loadRecommendations();
            } catch (error) {
                showAlert('L·ªói t·∫£i dashboard: ' + error.message, 'error');
            }
        }
        
        function renderCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            
            if (courses.length === 0) {
                grid.innerHTML = '<p>B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o. <a href="courses.html">Xem kh√≥a h·ªçc</a></p>';
                return;
            }
            
            grid.innerHTML = courses.map(course => `
                <div class="course-card">
                    <div class="course-card-body">
                        <h3>${course.course_name}</h3>
                        <p>${course.description || ''}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${course.progress_percentage || 0}%"></div>
                        </div>
                        <p style="text-align: center; margin-top: 0.5rem;">${(course.progress_percentage || 0).toFixed(1)}%</p>
                        <a href="course-detail.html?id=${course.course_id}" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Xem Chi Ti·∫øt</a>
                    </div>
                </div>
            `).join('');
        }
        
        function renderRecentQuizzes(quizzes) {
            const container = document.getElementById('recentQuizzes');
            
            if (quizzes.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm tra n√†o.</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>B√†i Ki·ªÉm Tra</th>
                            <th>ƒêi·ªÉm</th>
                            <th>K·∫øt Qu·∫£</th>
                            <th>Ng√†y L√†m</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${quizzes.map(quiz => `
                            <tr>
                                <td>Quiz #${quiz.quiz_id}</td>
                                <td>${quiz.score.toFixed(1)}%</td>
                                <td>${quiz.score >= 60 ? '<span style="color: var(--success-color);">ƒê·∫°t</span>' : '<span style="color: var(--danger-color);">Ch∆∞a ƒë·∫°t</span>'}</td>
                                <td>${formatDate(quiz.submitted_at)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        async function loadRecommendations() {
            try {
                const response = await aiAPI.getRecommendations(null, false);
                const recommendations = response.recommendations || [];
                
                const container = document.getElementById('recommendations');
                
                if (recommendations.length === 0) {
                    container.innerHTML = '<p>Ch∆∞a c√≥ g·ª£i √Ω n√†o. H√£y ho√†n th√†nh m·ªôt s·ªë b√†i h·ªçc ƒë·ªÉ nh·∫≠n g·ª£i √Ω t·ª´ AI!</p>';
                    return;
                }
                
                container.innerHTML = recommendations.slice(0, 5).map(rec => `
                    <div style="padding: 1rem; margin-bottom: 1rem; background: var(--light-color); border-radius: 5px;">
                        <strong>${rec.lesson_title || 'N·ªôi dung ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t'}</strong>
                        <p style="margin-top: 0.5rem; color: #6b7280;">${rec.reason}</p>
                        <a href="lesson.html?id=${rec.lesson_id}" class="btn btn-primary" style="margin-top: 0.5rem;">Xem B√†i H·ªçc</a>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading recommendations:', error);
            }
        }
        
        loadDashboard();

        // Notifications handling
        async function refreshNotifBadge() {
            try {
                const notes = await notificationsAPI.getMyNotifications(true);
                const badge = document.getElementById('notifBadge');
                if (notes && notes.length > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = String(notes.length);
                } else {
                    badge.style.display = 'none';
                }
            } catch (err) {
                console.debug('Unable to fetch notifications:', err);
            }
        }

        async function openNotifications() {
            try {
                const notes = await notificationsAPI.getMyNotifications(true);
                const el = document.getElementById('notificationsList');
                if (!notes || notes.length === 0) {
                    el.innerHTML = '<p>Kh√¥ng c√≥ th√¥ng b√°o m·ªõi.</p>';
                } else {
                    el.innerHTML = notes.map(n => `
                        <div style="padding:10px;border-bottom:1px solid #eee;">
                            <div style="font-weight:700">${n.title}</div>
                            <div style="color:#6b7280;margin-top:6px;">${n.message}</div>
                            <div style="font-size:12px;color:#9ca3af;margin-top:6px;">${n.created_at ? n.created_at.replace('T',' ') : ''}</div>
                        </div>
                    `).join('');
                }
                document.getElementById('notificationsModal').style.display = 'flex';
            } catch (err) {
                showAlert('L·ªói t·∫£i th√¥ng b√°o: ' + (err.message||err), 'error');
            }
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').style.display = 'none';
            // refresh badge after closing
            refreshNotifBadge();
        }

        // initial badge refresh
        refreshNotifBadge();
        
        // Chatbot functions
        function toggleChat() {
            const modal = document.getElementById('chatModal');
            const toggle = document.getElementById('chatToggle');
            if (modal.style.display === 'none') {
                modal.style.display = 'flex';
                toggle.style.display = 'none';
            } else {
                modal.style.display = 'none';
                toggle.style.display = 'flex';
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            // 1. Ki·ªÉm tra input r·ªóng
            if (!message || message.length === 0) {
                return;
            }
            
            // 2. X√≥a input & hi·ªÉn th·ªã tin nh·∫Øn user ngay l·∫≠p t·ª©c
            input.value = '';
            const messagesDiv = document.getElementById('chatMessages');
            
            messagesDiv.innerHTML += `
                <div style="text-align: right; margin-bottom: 10px;">
                    <div style="background: var(--primary-color); color: white; padding: 8px 12px; border-radius: 10px; display: inline-block; max-width: 80%; word-wrap: break-word;">
                        ${escapeHtml(message)}
                    </div>
                </div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // 3. Hi·ªÉn th·ªã "ƒêang suy nghƒ©..."
            const loadingId = 'loading-' + Date.now();
            messagesDiv.innerHTML += `
                <div id="${loadingId}" style="text-align: left; margin-bottom: 10px;">
                    <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 10px; display: inline-block; font-style: italic; color: #666;">
                        Bot ƒëang g√µ...
                    </div>
                </div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                // 4. G·ªçi API
                // L∆∞u √Ω: ƒê·∫£m b·∫£o api.js ƒë√£ tr·ªè ƒë√∫ng endpoint '/ai/chat'
                const response = await aiAPI.askQuestion(message);
                
                // 5. X√≥a loading
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                
                // 6. L·∫•y c√¢u tr·∫£ l·ªùi (∆Øu ti√™n ai_response theo backend m·ªõi)
                const botReply = response.ai_response || response.response || "Xin l·ªói, t√¥i kh√¥ng hi·ªÉu c√¢u h·ªèi.";
                
                messagesDiv.innerHTML += `
                    <div style="text-align: left; margin-bottom: 10px;">
                        <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 10px; display: inline-block; max-width: 80%; word-wrap: break-word;">
                            ${escapeHtml(botReply)}
                        </div>
                    </div>`;
            } catch (error) {
                console.error('Chat error:', error);
                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();
                
                messagesDiv.innerHTML += `
                    <div style="text-align: left; margin-bottom: 10px;">
                        <div style="background: #fee2e2; padding: 8px 12px; border-radius: 10px; color: #dc2626; display: inline-block;">
                            L·ªói: ${escapeHtml(error.message)}
                        </div>
                    </div>`;
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Allow Enter key to send message
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        // ========== Notifications ==========
        async function loadNotifications() {
            try {
                const notifs = await notificationsAPI.getAll(false);
                const unread = notifs.filter(n => !n.is_read);
                
                // Update badge
                const badge = document.getElementById('notifBadge');
                if (unread.length > 0) {
                    badge.textContent = unread.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
                
                // Store for modal
                window.allNotifications = notifs;
            } catch (e) {
                console.error('Failed to load notifications:', e);
            }
        }

        function openNotifications() {
            const modal = document.getElementById('notificationsModal');
            const list = document.getElementById('notificationsList');
            
            if (!window.allNotifications || window.allNotifications.length === 0) {
                list.innerHTML = '<p style="color: #999;">Kh√¥ng c√≥ th√¥ng b√°o n√†o.</p>';
                modal.style.display = 'flex';
                return;
            }
            
            list.innerHTML = window.allNotifications.map(n => `
                <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; background: ${n.is_read ? '#fff' : '#f0f9ff'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${n.title || 'Th√¥ng b√°o'}</strong>
                            <p style="margin: 6px 0 0; color: #666; font-size: 14px;">${n.message || ''}</p>
                            <small style="color: #999;">${new Date(n.created_at).toLocaleString('vi-VN')}</small>
                        </div>
                        ${!n.is_read ? `<button class="btn btn-sm" onclick="markNotifRead(${n.notification_id})">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            modal.style.display = 'flex';
        }

        function closeNotifications() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        async function markNotifRead(id) {
            try {
                await notificationsAPI.markRead(id);
                // Reload notifications
                await loadNotifications();
                openNotifications();
            } catch (e) {
                showAlert('L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc: ' + e.message, 'error');
            }
        }

        // Load notifications when page loads
        loadNotifications();
        // Refresh every 30 seconds
        notifRefreshInterval = setInterval(loadNotifications, 30000);
        window.addEventListener('beforeunload', () => {
            if (notifRefreshInterval) {
                clearInterval(notifRefreshInterval);
            }
        });
        // ========== Learning Goal Functions ==========
        function displayLearningGoal(goal) {
            const goalText = document.getElementById('goalText');
            if (goal && goal.trim()) {
                goalText.textContent = goal;
            } else {
                goalText.textContent = 'üìå B·∫°n ch∆∞a ƒë·∫∑t m·ª•c ti√™u. H√£y th√™m m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa b·∫°n!';
                goalText.style.color = '#999';
            }
        }

        function toggleEditGoal() {
            const display = document.getElementById('goalDisplay');
            const form = document.getElementById('goalEditForm');
            const input = document.getElementById('goalInput');
            
            if (form.style.display === 'none') {
                // Show edit form
                input.value = document.getElementById('goalText').textContent === 'üìå B·∫°n ch∆∞a ƒë·∫∑t m·ª•c ti√™u. H√£y th√™m m·ª•c ti√™u h·ªçc t·∫≠p c·ªßa b·∫°n!' ? '' : document.getElementById('goalText').textContent;
                form.style.display = 'block';
                display.style.display = 'none';
                input.focus();
            } else {
                // Hide edit form
                form.style.display = 'none';
                display.style.display = 'block';
            }
        }

        async function saveGoal() {
            try {
                const goal = document.getElementById('goalInput').value.trim();
                await authAPI.updateProfile({ learning_goal: goal });
                showAlert('M·ª•c ti√™u ƒë√£ l∆∞u!', 'success');
                displayLearningGoal(goal);
                toggleEditGoal();
            } catch (error) {
                showAlert('L·ªói l∆∞u m·ª•c ti√™u: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

