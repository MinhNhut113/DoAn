<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Kh√≥a H·ªçc</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="progress.html">Ti·∫øn ƒê·ªô</a></li>
                <li><a href="profile.html">H·ªì S∆°</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="card" id="courseInfo">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Danh S√°ch B√†i H·ªçc</div>
            <div id="lessonsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">B√†i Ki·ªÉm Tra</div>
            <div id="quizzesList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        
        if (!isAuthenticated()) {
            redirectTo('../index.html');
        }
        
        async function loadCourseDetail() {
            try {
                const course = await coursesAPI.getById(courseId);
                renderCourseInfo(course);
                
                const lessons = await lessonsAPI.getByCourse(courseId);
                renderLessons(lessons);
                
                const quizzes = await quizzesAPI.getAll(courseId);
                renderQuizzes(quizzes);
            } catch (error) {
                showAlert('L·ªói t·∫£i kh√≥a h·ªçc: ' + error.message, 'error');
            }
        }
        
        function renderCourseInfo(course) {
            const container = document.getElementById('courseInfo');
            
            container.innerHTML = `
                <h1>${course.course_name}</h1>
                <p style="margin: 1rem 0;">${course.description || ''}</p>
                ${course.is_enrolled ? `
                    <div class="progress-bar" style="margin: 1rem 0;">
                        <div class="progress-fill" style="width: ${course.progress_percentage || 0}%"></div>
                    </div>
                    <p>Ti·∫øn ƒë·ªô: ${(course.progress_percentage || 0).toFixed(1)}%</p>
                ` : `
                    <button class="btn btn-success" onclick="enrollCourse()">ƒêƒÉng K√Ω Kh√≥a H·ªçc</button>
                `}
            `;
        }
        
        function renderLessons(lessons) {
            const container = document.getElementById('lessonsList');
            
            if (lessons.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ b√†i h·ªçc n√†o.</p>';
                return;
            }
            
            container.innerHTML = `
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n B√†i H·ªçc</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${lessons.map((lesson, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${lesson.lesson_title}</td>
                                <td>
                                    ${lesson.is_completed ? '<span style="color: var(--success-color);">‚úì Ho√†n th√†nh</span>' : 'Ch∆∞a ho√†n th√†nh'}
                                </td>
                                <td>
                                    <a href="lesson.html?id=${lesson.lesson_id}" class="btn btn-primary">H·ªçc Ngay</a>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderQuizzes(quizzes) {
            const container = document.getElementById('quizzesList');
            
            if (quizzes.length === 0) {
                container.innerHTML = '<p>Ch∆∞a c√≥ b√†i ki·ªÉm tra n√†o.</p>';
                return;
            }
            
            container.innerHTML = quizzes.map(quiz => `
                <div style="padding: 1rem; margin-bottom: 1rem; background: var(--light-color); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${quiz.quiz_name}</strong>
                        ${quiz.time_limit_minutes ? `<p style="margin-top: 0.5rem; color: #6b7280;">Th·ªùi gian: ${quiz.time_limit_minutes} ph√∫t</p>` : ''}
                    </div>
                    <a href="quiz.html?id=${quiz.quiz_id}" class="btn btn-primary">L√†m B√†i</a>
                </div>
            `).join('');
        }
        
        async function enrollCourse() {
            try {
                await coursesAPI.enroll(courseId);
                showAlert('ƒêƒÉng k√Ω th√†nh c√¥ng!', 'success');
                loadCourseDetail();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }
        
        loadCourseDetail();
    </script>
</body>
</html>

