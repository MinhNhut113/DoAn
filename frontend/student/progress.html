<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theo D√µi Ti·∫øn ƒê·ªô - Sinh Vi√™n</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">üéì H·ªá Th·ªëng H·ªçc Tr·ª±c Tuy·∫øn AI</div>
            <ul class="navbar-menu">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="courses.html">Kh√≥a H·ªçc</a></li>
                <li><a href="progress.html">Ti·∫øn ƒê·ªô</a></li>
                <li><a href="profile.html">H·ªì S∆°</a></li>
                <li><a href="#" onclick="logout()">ƒêƒÉng Xu·∫•t</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 2rem;">Theo D√µi Ti·∫øn ƒê·ªô</h1>
        
        <div class="form-group">
            <label>Ch·ªçn Kh√≥a H·ªçc</label>
            <select id="courseSelect" onchange="loadProgress()">
                <option value="">T·∫•t C·∫£ Kh√≥a H·ªçc</option>
            </select>
        </div>
        
        <div class="card">
            <div class="card-header">Ti·∫øn ƒê·ªô Kh√≥a H·ªçc</div>
            <div id="courseProgress">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Ph√¢n T√≠ch ƒêi·ªÉm M·∫°nh & ƒêi·ªÉm Y·∫øu</div>
            <div style="position: relative; height: 400px;">
                <canvas id="analyticsChart"></canvas>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        let analyticsChart = null;
        
        if (!isAuthenticated()) {
            redirectTo('../index.html');
        }
        
        async function loadCourses() {
            try {
                const courses = await coursesAPI.getAll(true);
                const select = document.getElementById('courseSelect');
                
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.course_id;
                    option.textContent = course.course_name;
                    select.appendChild(option);
                });
                
                loadProgress();
            } catch (error) {
                showAlert('L·ªói t·∫£i kh√≥a h·ªçc: ' + error.message, 'error');
            }
        }
        
        async function loadProgress() {
            const courseId = document.getElementById('courseSelect').value;
            
            try {
                if (courseId) {
                    const progress = await progressAPI.getCourseProgress(courseId);
                    renderCourseProgress(progress);
                    
                    const analytics = await progressAPI.getAnalytics(courseId);
                    renderAnalytics(analytics);
                } else {
                    // Show overall progress
                    const dashboard = await progressAPI.getDashboard();
                    renderOverallProgress(dashboard);
                    
                    const analytics = await progressAPI.getAnalytics();
                    renderAnalytics(analytics);
                }
            } catch (error) {
                showAlert('L·ªói t·∫£i ti·∫øn ƒë·ªô: ' + error.message, 'error');
            }
        }
        
        function renderCourseProgress(progress) {
            const container = document.getElementById('courseProgress');
            
            container.innerHTML = `
                <h3>Ti·∫øn ƒê·ªô: ${progress.progress_percentage.toFixed(1)}%</h3>
                <div class="progress-bar" style="margin: 1rem 0;">
                    <div class="progress-fill" style="width: ${progress.progress_percentage}%"></div>
                </div>
                <p><strong>T·ªïng b√†i h·ªçc:</strong> ${progress.total_lessons}</p>
                <p><strong>ƒê√£ ho√†n th√†nh:</strong> ${progress.completed_lessons}</p>
                <p><strong>Th·ªùi gian h·ªçc:</strong> ${progress.total_time_spent_minutes} ph√∫t</p>
                
                <h4 style="margin-top: 2rem;">Chi Ti·∫øt B√†i H·ªçc</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n B√†i H·ªçc</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>Th·ªùi Gian</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${progress.lessons.map((lesson, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${lesson.lesson_title}</td>
                                <td>${lesson.is_completed ? '<span style="color: var(--success-color);">‚úì Ho√†n th√†nh</span>' : 'Ch∆∞a ho√†n th√†nh'}</td>
                                <td>${lesson.time_spent_minutes} ph√∫t</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        function renderOverallProgress(dashboard) {
            const container = document.getElementById('courseProgress');
            
            container.innerHTML = `
                <h3>T·ªïng Quan Ti·∫øn ƒê·ªô</h3>
                <p><strong>T·ªïng kh√≥a h·ªçc:</strong> ${dashboard.courses_progress.length}</p>
                <p><strong>B√†i h·ªçc ƒë√£ ho√†n th√†nh:</strong> ${dashboard.total_lessons_completed}</p>
                
                <h4 style="margin-top: 2rem;">Ti·∫øn ƒê·ªô T·ª´ng Kh√≥a H·ªçc</h4>
                ${dashboard.courses_progress.map(cp => `
                    <div style="margin-bottom: 1rem;">
                        <p><strong>Kh√≥a h·ªçc #${cp.course_id}:</strong> ${cp.progress_percentage.toFixed(1)}%</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${cp.progress_percentage}%"></div>
                        </div>
                    </div>
                `).join('')}
            `;
        }
        
        function renderAnalytics(analytics) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            
            if (analyticsChart) {
                analyticsChart.destroy();
            }
            
            if (!analytics.analytics || analytics.analytics.length === 0) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '16px Arial';
                ctx.fillText('Ch∆∞a c√≥ d·ªØ li·ªáu ph√¢n t√≠ch', 50, 200);
                return;
            }
            
            const topics = analytics.analytics.map(a => a.topic_name);
            const strengths = analytics.analytics.map(a => a.strength_score);
            const weaknesses = analytics.analytics.map(a => a.weakness_score);
            
            analyticsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topics,
                    datasets: [
                        {
                            label: 'ƒêi·ªÉm M·∫°nh (%)',
                            data: strengths,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ƒêi·ªÉm Y·∫øu (%)',
                            data: weaknesses,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
        
        loadCourses();
    </script>
</body>
</html>

